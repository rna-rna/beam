Update Mutation to Gracefully Handle API Responses:
Modify the mutation to strictly check for API failures rather than relying solely on the presence of the success key.
tsx
Copy code
const toggleStarMutation = useMutation({
  mutationFn: async ({ imageId, isStarred }) => {
    const token = await getToken();
    const res = await fetch(`/api/images/${imageId}/star`, {
      method: isStarred ? 'DELETE' : 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${token}`
      },
    });

    const result = await res.json();
    console.log('Star API Response:', result);

    // Handle explicit error conditions
    if (!res.ok || result?.success === false) {
      throw new Error(result?.message || 'Failed to update star status');
    }

    // Return result to sync with optimistic update
    return {
      success: true,
      data: result?.data || null,
      message: result?.message || 'Star status updated successfully'
    };
  },
  onMutate: async ({ imageId, isStarred }) => {
    await queryClient.cancelQueries({ queryKey: [`/api/galleries/${slug}`] });

    const previousGallery = queryClient.getQueryData([`/api/galleries/${slug}`]);

    // Optimistic UI update to toggle star
    queryClient.setQueryData([`/api/galleries/${slug}`], (old: any) => ({
      ...old,
      images: old?.images.map((img: Image) =>
        img.id === imageId ? { ...img, starred: !isStarred } : img
      )
    }));

    return { previousGallery };
  },
  onError: (err, variables, context) => {
    // Revert UI to the previous state if the API fails
    if (context?.previousGallery) {
      queryClient.setQueryData([`/api/galleries/${slug}`], context.previousGallery);
    }
    toast({
      title: "Error",
      description: err.message || "Failed to update star status. Please try again.",
      variant: "destructive",
    });
  },
  onSuccess: (_, variables) => {
    // Invalidate only star queries to avoid full gallery reload
    queryClient.invalidateQueries({ queryKey: [`/api/images/${variables.imageId}/stars`] });
  },
  onSettled: () => {
    queryClient.invalidateQueries({ queryKey: [`/api/galleries/${slug}`] });
  }
});
